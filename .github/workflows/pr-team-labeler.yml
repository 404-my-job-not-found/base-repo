name: Auto Label by Team Member

on:
  pull_request:
    types: [opened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Add team labels based on member name in PR title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Organization Secretì—ì„œ íŒ€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const teamInfo = '${{ secrets.TEAM_INFO }}';

            if (!teamInfo) {
              console.log('TEAM_INFO secret not found');
              return;
            }

            let teams;
            try {
              // JSON í˜•íƒœë¡œ íŒŒì‹±
              teams = JSON.parse(teamInfo);
            } catch (error) {
              console.error('Error parsing TEAM_INFO secret:', error);
              return;
            }

            // PR íƒ€ì´í‹€ ê°€ì ¸ì˜¤ê¸°
            const prTitle = context.payload.pull_request.title.toLowerCase();
            console.log(`PR Title: ${prTitle}`);

            // ë¶™ì¼ ë¼ë²¨ë“¤ì„ ì €ì¥í•  Set (ì¤‘ë³µ ë°©ì§€)
            const labelsToAdd = new Set();

            // ê° íŒ€ì˜ ë©¤ë²„ë“¤ì„ í™•ì¸
            for (const [teamName, members] of Object.entries(teams)) {
              console.log(`Checking team: ${teamName}, members: ${members}`);
              
              // íŒ€ ë©¤ë²„ë“¤ì˜ ì´ë¦„ì´ PR íƒ€ì´í‹€ì— ìˆëŠ”ì§€ í™•ì¸
              for (const member of members) {
                if (member && member.trim()) {
                  // ì •í™•í•œ ë‹¨ì–´ ë§¤ì¹­ì„ ìœ„í•œ ì •ê·œí‘œí˜„ì‹
                  const regex = new RegExp(`\\b${member.toLowerCase().trim()}\\b`, 'i');
                  
                  if (regex.test(prTitle)) {
                    const labelName = `team-${teamName.toLowerCase()}`;
                    labelsToAdd.add(labelName);
                    console.log(`Found member: ${member} from team: ${teamName} -> adding label: ${labelName}`);
                    break; // í•´ë‹¹ íŒ€ì—ì„œ í•œ ëª…ì´ë¼ë„ ì°¾ìœ¼ë©´ ë” ì´ìƒ í™•ì¸í•˜ì§€ ì•ŠìŒ
                  }
                }
              }
            }

            // ë¼ë²¨ ì¶”ê°€
            if (labelsToAdd.size > 0) {
              const labelsArray = Array.from(labelsToAdd);
              
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: labelsArray
                });
                
                console.log(`Successfully added labels: ${labelsArray.join(', ')}`);
                
                // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€ (ì„ íƒì‚¬í•­)
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `ğŸ·ï¸ íŒ€ ë©¤ë²„ê°€ ê°ì§€ë˜ì–´ ìë™ìœ¼ë¡œ ë¼ë²¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ${labelsArray.map(label => `\`${label}\``).join(', ')}`
                });
                
              } catch (error) {
                console.error('Error adding labels:', error);
                
                // ë¼ë²¨ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
                for (const label of labelsArray) {
                  try {
                    // íŒ€ë³„ ìƒ‰ìƒ ì„¤ì •
                    const teamColors = {
                      'team-teama': '0052cc',
                      'team-teamb': 'ff6b6b', 
                      'team-teamc': '4ecdc4',
                      'team-teamd': 'ffe66d'
                    };
                    
                    const color = teamColors[label] || 'E91E63';
                    
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label,
                      color: color,
                      description: `Team label for ${label.replace('team-', '')}`
                    });
                    console.log(`Created new label: ${label}`);
                  } catch (createError) {
                    if (!createError.message.includes('already_exists')) {
                      console.error(`Error creating label ${label}:`, createError);
                    }
                  }
                }
                
                // ë¼ë²¨ ìƒì„± í›„ ë‹¤ì‹œ ì¶”ê°€ ì‹œë„
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    labels: labelsArray
                  });
                  console.log(`Successfully added labels after creation: ${labelsArray.join(', ')}`);
                } catch (retryError) {
                  console.error('Error adding labels after creation:', retryError);
                }
              }
            } else {
              console.log('No team member names found in PR title');
            }
